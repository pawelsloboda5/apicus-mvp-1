# Email Generation Feature Plan

## 1. Overview

This feature will allow users to generate a pre-populated HTML email based on the current scenario's ROI data. The email will follow a provided template and be editable by the user with AI assistance. The user will be able to copy the HTML or download it as an .html file.

## 2. UI/UX Design

*   **Trigger Button:**
    *   A "Generate Email" button will be added to the `StatsBar.tsx` component.
    *   The button should fit aesthetically with the existing controls (e.g., using a relevant icon like `Mail` or `Send`).
    *   Button states: default, hover, active, disabled (e.g., if ROI data is incomplete or an email generation is in progress).
*   **Email Preview Modal/Page:**
    *   Clicking "Generate Email" will open a modal or a new dedicated page section (likely a modal for MVP to keep context).
    *   This modal will display a live preview of the email using an `iframe`.
    *   It will also show the raw HTML (perhaps in a collapsible section or a separate tab within the modal).
    *   Input fields will be provided for user-specific details: `[FIRST NAME]`, `[YOUR NAME]`, `[YOUR COMPANY]`, `[YOUR_EMAIL]`, `[CALENDLY_LINK]`, `[PDF_LINK]`.
    *   These fields will have default placeholders and update the live preview and raw HTML in real-time.
*   **Editable Sections with AI Assist:**
    *   Certain paragraphs in the email template (e.g., the "Hook" and "CTA paragraph") will be designated as editable.
    *   Clicking an "Edit with AI" button or icon next to these sections will allow the user to choose from 3 predefined system prompts/angles to rewrite that section.
    *   The chosen prompt, along with the current scenario's ROI data and the existing text of that section, will be sent to the OpenAI API.
    *   The AI's suggested rewrite will replace the content in the preview and raw HTML.
    *   The user should be able to accept the suggestion or perhaps regenerate.
*   **Actions:**
    *   "Copy HTML" button: Copies the raw HTML to the clipboard.
    *   "Download HTML" button: Downloads the `rawHtml` as an `email.html` file.
    *   "Close" or "Done" button for the modal.
*   **Loading State:**
    *   A loading indicator (e.g., spinner on the "Generate Email" button or within the modal) will be displayed while the initial email content is being generated by the AI (if the initial population also uses AI) and when AI is assisting with section edits.

## 3. Component Breakdown

*   **`StatsBar.tsx`:**
    *   Add a new `Button` component for "Generate Email".
    *   Manage the open state for the email generation modal.
*   **`EmailGenerationModal.tsx` (New Component):**
    *   This component will house the entire email generation UI.
    *   It will receive the current scenario's ROI data as props.
    *   It will use the `EmailTemplate.tsx` component for rendering the preview and getting raw HTML.
    *   It will manage local state for the editable fields (`firstName`, `yourName`, etc.) and the content of AI-editable sections.
    *   It will handle API calls to OpenAI for AI-assisted editing.
*   **`EmailTemplate.tsx` (New Component based on provided pseudocode):**
    *   Takes `EmailTemplateProps` (firstName, stats, etc.).
    *   Uses `useMemo` to generate `rawHtml` based on props.
    *   Renders an `iframe` for live preview, `srcDoc` will be `rawHtml`.
    *   Provides `copyToClipboard` and `downloadHtml` utility functions/buttons.
    *   The HTML structure will be based on the provided Gmail template.

## 4. Data Flow & State Management

*   The `StatsBar` button click will trigger the opening of the `EmailGenerationModal`.
*   The current scenario's ROI data (runsPerMonth, netROI, roiRatio, paybackPeriod, etc., from `currentScenario` object in `app/build/page.tsx` which is derived from `lib/roi-utils.ts` calculations) will be passed to the `EmailGenerationModal`.
*   `EmailGenerationModal` will initialize its local state for editable fields with defaults or user-provided data (if we decide to persist these email-specific fields later, perhaps in `Scenario` object in Dexie).
*   ROI stats needed for the email's mini stat bar (`stats.roiX`, `stats.payback`, `stats.runs`) will be derived from the scenario data.
*   Changes to input fields in the modal will update the local state and re-render `EmailTemplate.tsx` (triggering `useMemo` to update `rawHtml` and the iframe preview).
*   For AI-assisted editing:
    *   The current text of the section, the chosen AI prompt template, and relevant ROI data are sent to an OpenAI API endpoint (likely a new Next.js API route `/api/openai/generate-email-section`).
    *   The API route proxies the request to OpenAI.
    *   The response updates the relevant section's content in the modal's local state, which then flows to `EmailTemplate.tsx`.

## 5. OpenAI Integration

*   **Initial Email Population (Optional AI use):**
    *   The main body/hook of the email could be initially drafted by AI based on the overall ROI figures and the scenario name/description.
    *   Prompt: "You are an automation consultant. Based on the following ROI data for a workflow named '[Scenario Name]', write a compelling 2-3 sentence hook for a cold outreach email. ROI Data: [Time Saved, Net ROI, ROI Ratio, Platform used, Number of steps if available]. Focus on the most impressive metric."
*   **AI-Assisted Section Editing:**
    *   For each editable section, 3 distinct system prompt templates will be available. For example, for the "Hook" paragraph:
        1.  **Focus on Time/Cost Savings:** "Rewrite this email section to emphasize the time and direct cost savings. ROI Data: {...}"
        2.  **Focus on Efficiency/Productivity:** "Rewrite this email section to highlight improvements in efficiency and productivity. ROI Data: {...}"
        3.  **Focus on Strategic Impact/Payback:** "Rewrite this email section to focus on the strategic business impact and rapid payback. ROI Data: {...}"
    *   The API call will include the chosen prompt template, the current ROI data (time saved, platform cost, net ROI, ROI ratio, payback period, runs per month, minutes per run), and the existing text of the section to be rewritten.
    *   The OpenAI model should be instructed to return only the rewritten text for that specific section.
*   **Data to send to OpenAI:**
    *   Current scenario name (if available).
    *   Key ROI metrics: `timeValue`, `platformCost`, `netROI`, `roiRatio`, `paybackPeriod`, `runsPerMonth`, `minutesPerRun` (from `currentScenario` which gets these from `lib/roi-utils.ts` calculations).
    *   The specific section of the email text to be rewritten (if editing).
    *   The selected AI prompt template for rewriting.

## 6. Implementation Steps

1.  **Create `EmailTemplate.tsx`:**
    *   [x] Implement the React component based on the provided pseudocode.
    *   [x] Ensure props are correctly typed (`EmailTemplateProps`).
    *   [x] Style the preview iframe and action buttons.
2.  **Modify `StatsBar.tsx`:**
    *   [x] Add the "Generate Email" button with appropriate styling and icon.
    *   [x] Add state to manage the visibility of the `EmailGenerationModal`.
3.  **Create `EmailGenerationModal.tsx`:**
    *   [x] Scaffold the modal structure (using `Sheet` or `Dialog` from shadcn/ui).
    *   [x] Include input fields for `firstName`, `yourName`, etc.
    *   [x] Integrate `EmailTemplate.tsx` for preview and HTML generation.
    *   [x] Pass down ROI data and editable field states to `EmailTemplate.tsx`.
    *   [x] Persist user-entered details (firstName, yourName, etc.) to Dexie when fields lose focus or AI edits are made.
4.  **Implement Initial Data Population:**
    *   [x] When the modal opens, populate the `stats` prop for `EmailTemplate.tsx` using data from the current scenario (e.g., `currentScenario.runsPerMonth`, calculated `netROI`, `roiRatio`, `paybackPeriod`).
    *   [x] Load persisted email-specific fields (firstName, yourName, etc.) from `currentScenario`.
5.  **Implement AI-Assisted Editing:**
    *   Add "Edit with AI" buttons for designated email sections.
    *   Create UI for selecting one of the 3 AI prompt templates.
    *   Implement the Next.js API route (e.g., `/api/openai/generate-email-section`) to handle requests to OpenAI, passing the prompt, ROI data, and current section text.
    *   Update the modal's state with the AI's response, refreshing the preview.
6.  **Add Loading States:** Show loading indicators during AI calls.
7.  **Testing:** Thoroughly test the email generation, preview, HTML copying/downloading, and AI editing features.
8.  **Documentation:** Update `TASKS.md`, `README.md` and other relevant docs with this new feature.

## 7. Future Considerations (Post-MVP)

*   Persisting user-defined email fields (yourName, yourCompany, etc.) in local storage or user profile.
*   Allowing users to create and save their own email prompt templates.
*   More sophisticated AI interaction, like direct text editing with AI suggestions inline.
*   Integration with actual email clients (e.g., pre-filling a Gmail compose window).
*   Saving generated emails or drafts associated with a scenario. 